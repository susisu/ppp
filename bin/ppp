#!/usr/bin/env node

"use strict";

const indent = require("indent-string");

const printer = require("../lib/printer");

process.title = "ppp";
process.stdin.setEncoding("utf8");

function readStdin() {
  let buffer = "";

  return new Promise((resolve, reject) => {
    process.stdin.on("readable", () => {
      const chunk = process.stdin.read();
      if (chunk !== null) {
        buffer += chunk;
      }
    });
    process.stdin.on("end", () => {
      resolve(buffer);
    });
  });
}

function assertObject(val) {
  if (typeof val !== "object" || val === null) {
    throw new TypeError("Unexpected format");
  }
}

// TODO
const fields = printer.availableFileds;

const wrapSize = 80;
const indentSize = 2;

async function main() {
  const input = await readStdin();
  const data = JSON.parse(input);
  assertObject(data);
  const pkg = Array.isArray(data) ? data[data.length - 1] : data;
  assertObject(pkg);
  const text = indent(
    printer.print(pkg, fields, wrapSize - indentSize, indentSize),
    indentSize
  );
  process.stdout.write(text + "\n");
}

main().catch(err => {
  process.stderr.write(String(err) + "\n");
});
